<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸŽƒ Halloween Map of Decorations ðŸŽƒ</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body {
  font-family: 'Comic Sans MS', cursive, sans-serif;
  background-color: #1a1a1a;
  color: #fff;
  margin: 0;
  padding: 0;
}

header {
  background-color: #000;
  border-bottom: 4px solid orange;
  padding: 20px;
  text-align: center;
}

header h1 {
  margin: 0;
  color: orange;
  text-shadow: 2px 2px #550000;
}

/* Drawer styling */
#drawer {
  position: fixed;
  top: 0;
  left: -300px; /* hidden */
  width: 300px;
  height: 100%;
  background-color: #111;
  border-right: 3px solid orange;
  padding: 20px;
  box-sizing: border-box;
  transition: left 0.3s ease;
  z-index: 1000;
}

#drawer.open {
  left: 0;
}

#drawer h2 {
  color: orange;
  margin-top: 0;
}

#drawer input[type="text"] {
  width: 100%;
  padding: 8px;
  margin: 5px 0 15px 0;
  border: 2px solid orange;
  border-radius: 5px;
  background-color: #333;
  color: #fff;
}

/* Submit button inside drawer */
#submitBtn {
  width: 100%;
  padding: 10px;
  background-color: orange;
  border: 2px solid #fff;
  border-radius: 5px;
  font-weight: bold;
  cursor: pointer;
  color: #000;
  transition: all 0.2s ease-in-out;
}

#submitBtn:hover {
  background-color: #fff;
  color: orange;
  transform: scale(1.05);
}

/* Drawer toggle button */
#drawerToggle {
  position: fixed;
  top: 20px;
  left: 20px;
  background-color: orange;
  color: black;
  padding: 10px 15px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  z-index: 1100;
}

#map {
  width: 100%;
  height: calc(100vh - 80px);
  margin-top: 0;
  z-index: 0;
}
</style>
</head>
<body>

<header>
  <h1>ðŸŽƒ Halloween Map of Decorations ðŸŽƒ</h1>
</header>

<button id="drawerToggle">Add a House</button>

<div id="drawer">
  <h2>Submit a House</h2>
  <input id="description" type="text" placeholder="Description">
  <input id="submittedBy" type="text" placeholder="Your Name">
  <input id="address" type="text" placeholder="Address (optional)">
  <button id="submitBtn">Submit</button>
  <p style="color: #ffb347; font-size: 0.9em; margin-top: 10px;">Click on the map to drop a pin for this house.</p>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ==== CONFIGURATION ==== */
  // https://docs.google.com/forms/d/e/1FAIpQLSdgCImO8bsN1qFCY5fLMp_eDY78W65N6Imcxs_-5SSS8iZc3g/viewform?usp=pp_url&entry.1671409061=ben&entry.1642471479=downtown+waxhaw&entry.567850449=123+waxhaw&entry.645736728=123&entry.418865114=-123
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdgCImO8bsN1qFCY5fLMp_eDY78W65N6Imcxs_-5SSS8iZc3g/formResponse"; // Pending
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1P5aKelejpBrCTV_3tycCM3RukUFjWQmxH4IdIZVHO8I/gviz/tq?tqx=out:json&sheet=Approved"; // Approved

/* ==== DRAWER TOGGLE ==== */
const drawer = document.getElementById('drawer');
const toggleBtn = document.getElementById('drawerToggle');
toggleBtn.addEventListener('click', () => {
  drawer.classList.toggle('open');
});

/* ==== INITIALIZE MAP ==== */
const map = L.map('map').setView([39.5, -98.35], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
}).addTo(map);

let marker = null;
map.on('click', function(e) {
  if (marker) map.removeLayer(marker);
  marker = L.marker(e.latlng).addTo(map);
  marker.bindPopup("ðŸŽƒ Selected location").openPopup();
});

/* ==== LOAD APPROVED PINS ==== */
async function loadApprovedPins() {
  try {
    const response = await fetch(SHEET_URL);
    const text = await response.text();
    const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
    const rows = json.table.rows;

    rows.forEach(row => {
      const name = row.c[1] ? row.c[1].v : "";
      const description = row.c[2] ? row.c[2].v : "";
      const address = row.c[3] ? row.c[3].v : "";
      const lat = row.c[4] ? parseFloat(row.c[4].v) : null;
      const lng = row.c[5] ? parseFloat(row.c[5].v) : null;

      if (lat && lng) {
        L.marker([lat, lng]).addTo(map)
          .bindPopup(`<b>${description}</b><br>${address}<br>Submitted by: ${name}`);
      }
    });
  } catch (err) {
    console.error("Failed to load pins:", err);
  }
}

loadApprovedPins();

/* ==== SUBMIT HANDLER ==== */
document.getElementById("submitBtn").addEventListener("click", async function() {
  const description = document.getElementById("description").value.trim();
  const submittedBy = document.getElementById("submittedBy").value.trim();
  const address = document.getElementById("address").value.trim();

  if (!description || !submittedBy) {
    alert("Please fill in Description and Your Name.");
    return;
  }
  if (!marker) {
    alert("Please drop a pin on the map!");
    return;
  }

  const lat = marker.getLatLng().lat;
  const lng = marker.getLatLng().lng;

  const formData = new FormData();
  formData.append("entry.1642471479", description);
  formData.append("entry.1671409061", submittedBy);
  formData.append("entry.1122334455", address); // replace with your Form entry ID
  formData.append("entry.645736728", lat);
  formData.append("entry.418865114", lng);

  try {
    await fetch(FORM_URL, { method: "POST", mode: "no-cors", body: formData });
    alert("Submission sent! Your pin will be added once approved.");
    document.getElementById("description").value = "";
    document.getElementById("submittedBy").value = "";
    document.getElementById("address").value = "";
    if (marker) map.removeLayer(marker);
    marker = null;
  } catch (err) {
    console.error("Submission failed:", err);
    alert("Error connecting to Google Form.");
  }
});
</script>

</body>
</html>
